name: CI

on:
  push:

permissions:
  contents: read

jobs:
  build-and-smoke:
    name: ${{ matrix.runner }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner:
          - ubuntu-latest
          - ubuntu-22.04-arm
          - windows-latest
          - macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (Linux/macOS)
        if: matrix.runner != 'windows-latest'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup MSYS2 (Windows)
        if: matrix.runner == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            make
            gcc
            python

      - name: Install build deps (Ubuntu)
        if: startsWith(matrix.runner, 'ubuntu')
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build (Linux/macOS)
        if: matrix.runner != 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail
          make -C src clean >/dev/null 2>&1 || true
          make -C src -j"$(getconf _NPROCESSORS_ONLN || echo 2)" CC=cc

      - name: Build (Windows/MSYS2)
        if: matrix.runner == 'windows-latest'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          make -C src clean >/dev/null 2>&1 || true
          make -C src -j2 CC=gcc

      - name: Smoke test (Linux/macOS)
        if: matrix.runner != 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail
          export MUHAN_HOME="$GITHUB_WORKSPACE"
          log_file="/tmp/frp.log"

          ./src/frp.new -r 4102 >"$log_file" 2>&1 &
          pid=$!

          cleanup() {
            kill -9 "$pid" >/dev/null 2>&1 || true
            wait "$pid" 2>/dev/null || true
          }
          trap cleanup EXIT

          sleep 2
          if ! kill -0 "$pid" >/dev/null 2>&1; then
            echo "smoke failed: server exited immediately"
            tail -n 200 "$log_file" || true
            exit 1
          fi

          MUD_PORT=4102 python tests/smoke/session_smoke.py

      - name: Smoke test (Windows/MSYS2)
        if: matrix.runner == 'windows-latest'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          export MUHAN_HOME="$GITHUB_WORKSPACE"
          log_file="/tmp/frp.log"
          bin="./src/frp.new"

          if [[ ! -x "$bin" && -x "./src/frp.new.exe" ]]; then
            bin="./src/frp.new.exe"
          fi

          "$bin" -r 4102 >"$log_file" 2>&1 &
          pid=$!

          cleanup() {
            kill -9 "$pid" >/dev/null 2>&1 || true
            wait "$pid" 2>/dev/null || true
          }
          trap cleanup EXIT

          sleep 2
          if ! kill -0 "$pid" >/dev/null 2>&1; then
            echo "smoke failed: server exited immediately"
            tail -n 200 "$log_file" || true
            exit 1
          fi

          MUD_PORT=4102 python tests/smoke/session_smoke.py
